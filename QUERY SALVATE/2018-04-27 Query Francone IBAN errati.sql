use CLC


/*
CREATE table #mandati (NumeroMandato varchar(50))

/*

--INSERT into #mandati (NumeroMandato)
SELECT
	'0003007267' UNION ALL
SELECT
	'0003004010' UNION ALL
SELECT
	'0003009586' UNION ALL
SELECT
	'0003012051' UNION ALL
SELECT
	'0003007265' UNION ALL
SELECT
	'0003007945' UNION ALL
SELECT
	'0003010293' UNION ALL
SELECT
	'0003012951' UNION ALL
SELECT
	'0003003742' UNION ALL
SELECT
	'0003006051' UNION ALL
SELECT
	'0003013416' UNION ALL
SELECT
	'0003003084' UNION ALL
SELECT
	'0003004012' UNION ALL
SELECT
	'0003007271' UNION ALL
SELECT
	'0003012573' UNION ALL
SELECT
	'0003007607' UNION ALL
SELECT
	'0003011062' UNION ALL
SELECT
	'0003007264' UNION ALL
SELECT
	'0003003082' UNION ALL
SELECT
	'0003003083' UNION ALL
SELECT
	'0003003085' UNION ALL
SELECT
	'0003006766' UNION ALL
SELECT
	'0003007305' UNION ALL
SELECT
	'0003007315' UNION ALL
SELECT
	'0003009007' UNION ALL
SELECT
	'0003009709' UNION ALL
SELECT
	'0003010761' UNION ALL
SELECT
	'0003011553' UNION ALL
SELECT
	'0003009708' UNION ALL
SELECT
	'0003004011' UNION ALL
SELECT
	'0003006050' UNION ALL
SELECT
	'0003009587' UNION ALL
SELECT
	'0003012950' UNION ALL
SELECT
	'0003010822' UNION ALL
SELECT
	'0003002088' UNION ALL
SELECT
	'0003002120' UNION ALL
SELECT
	'0003006296' UNION ALL
SELECT
	'0003001288' UNION ALL
SELECT
	'0003001679' UNION ALL
SELECT
	'0003002514' UNION ALL
SELECT
	'0003004211' UNION ALL
SELECT
	'0003005076' UNION ALL
SELECT
	'0003000029' UNION ALL
SELECT
	'0003000485' UNION ALL
SELECT
	'0003001358' UNION ALL
SELECT
	'0003001923' UNION ALL
SELECT
	'0003002710' UNION ALL
SELECT
	'0003003094' UNION ALL
SELECT
	'0003003782' UNION ALL
SELECT
	'0003004659' UNION ALL
SELECT
	'0003000835' UNION ALL
SELECT
	'0003004696' UNION ALL
SELECT
	'0003009183' UNION ALL
SELECT
	'0003014610' UNION ALL
SELECT
	'0003002736' UNION ALL
SELECT
	'0003001356' UNION ALL
SELECT
	'0003002708' UNION ALL
SELECT
	'0003000439' UNION ALL
SELECT
	'0003002420' UNION ALL
SELECT
	'0003003338' UNION ALL
SELECT
	'0003006000' UNION ALL
SELECT
	'0003007756' UNION ALL
SELECT
	'0003006690' UNION ALL
SELECT
	'0003001954' UNION ALL
SELECT
	'0003002758' UNION ALL
SELECT
	'0003003772' UNION ALL
SELECT
	'0003004093' UNION ALL
SELECT
	'0003004203' UNION ALL
SELECT
	'0003010327' UNION ALL
SELECT
	'0003012476' UNION ALL
SELECT
	'0003004196' UNION ALL
SELECT
	'0003006949' UNION ALL
SELECT
	'0003002606' UNION ALL
SELECT
	'0003002757' UNION ALL
SELECT
	'0003006952' UNION ALL
SELECT
	'0003002703' UNION ALL
SELECT
	'0003004209' UNION ALL
SELECT
	'0003001363' UNION ALL
SELECT
	'0003002499' UNION ALL
SELECT
	'0003002701' UNION ALL
SELECT
	'0003003053' UNION ALL
SELECT
	'0003003296' UNION ALL
SELECT
	'0003003301' UNION ALL
SELECT
	'0003006921' UNION ALL
SELECT
	'0003009527' UNION ALL
SELECT
	'0003014861' UNION ALL
SELECT
	'0003001722' UNION ALL
SELECT
	'0003003050' UNION ALL
SELECT
	'0003003295' UNION ALL
SELECT
	'0003004210'	

*/

SELECT DISTINCT #mandati.NumeroMandato FROM #mandati inner JOIN T_Mandato on #mandati.NumeroMandato = T_Mandato.NumeroMandato

INSERT INTO #mandati (NumeroMandato)
SELECT NumeroMandato FROM T_Mandato where NumeroMandato IN ('3000485'
,'3014610'
,'3000439'
)

*/

SELECT T_R_Incarico_Mandato.IdIncarico
--,T_Incarico.CodTipoIncarico
,D_TipoIncarico.Descrizione [Tipo Incarico]
		,anagrafica.ChiaveClienteIntestatario [Codice Cliente]
		,anagrafica.CodicePromotore as [Codice Agente]
		,#mandati.NumeroMandato [Numero Mandato]
		,S_Operatore.Etichetta as Operatore
		 ,D_SedeOperatore.Descrizione as Sede
		 ,DataTransizione 
from T_R_Incarico_Mandato 

join T_Mandato on T_Mandato.IdMandato = T_R_Incarico_Mandato.IdMandato
JOIN #mandati on #mandati.NumeroMandato = T_Mandato.NumeroMandato


left JOIN (select MIN(IdTransizione) IdTransizione 
				, idincarico 
		from L_WorkflowIncarico 
		where CodstatoWorkflowIncaricoDestinazione in (6604, 6605 )--in attesa ricez bonifico
		--and CodAttributoIncaricoDestinazione is NULL 
		GROUP BY IdIncarico) wf ON wf.IdIncarico = T_R_Incarico_Mandato.IdIncarico

left JOIN L_WorkflowIncarico on wf.IdTransizione = L_WorkflowIncarico.IdTransizione

left join S_Operatore on L_WorkflowIncarico.IdOperatore = S_Operatore.IdOperatore

left join D_SedeOperatore on CodSede = Codice
--where T_R_Incarico_Mandato.IdIncarico = 10045483

join T_Incarico on T_R_Incarico_Mandato.IdIncarico = T_Incarico.IdIncarico
JOIN D_TipoIncarico on CodTipoIncarico = D_TipoIncarico.Codice

JOIN rs.v_CESAM_Anagrafica_Cliente_Promotore anagrafica ON anagrafica.IdIncarico = T_Incarico.IdIncarico



ORDER BY #mandati.NumeroMandato


--select * FROM D_StatoWorkflowIncarico where Descrizione like '%assegno'

